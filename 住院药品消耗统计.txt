--总数 = 实发 - 冲销
select table_zzzz."Drug_Id", table_zzzz."Drug_Code" , table_zzzz."Drug_Name" , table_zzzz."Min_Unit" , table_zzzz."Drug_Strength"  
, (table_zzzz."Min_Unit_Quantity_final" - table_zzzz."Min_Unit_Quantity") as "Min_Unit_Quantity_final"
, (table_zzzz."Retail_Chrg_final" - table_zzzz."Retail_Chrg") as "Retail_Chrg_final"
from 
(
select  table_zzz."Drug_Id", table_zzz."Drug_Code" , table_zzz."Drug_Name" , table_zzz."Min_Unit" , table_zzz."Drug_Strength" 
, table_zzz."Min_Unit_Quantity_final" as "Min_Unit_Quantity_final" 
, table_zzz."Retail_Chrg_final" as "Retail_Chrg_final"
, coalesce (table_RedrugNum."Min_Unit_Quantity", 0) as "Min_Unit_Quantity"
, coalesce (table_RedrugNum."Retail_Chrg", 0) as "Retail_Chrg"
from (
--此为所有已发的数量，需要再减去所有销账的数量
select table_zz."Drug_Id", table_zz."Drug_Code" , table_zz."Drug_Name" , table_zz."Min_Unit" , table_zz."Drug_Strength" , sum(table_zz."Min_Unit_Quantity") as "Min_Unit_Quantity_final" 
, sum(table_zz."Retail_Chrg") as "Retail_Chrg_final"
from (
--单张单据计算真正的合计金额
select table_z."Drug_Id", table_z."Grdrug_No", table_z."Drug_Code" , table_z."Drug_Name", table_z."Min_Unit", table_z."Drug_Strength", table_z."Min_Unit_Quantity", table_z."Recipe_Plcdept", table_z."Retail_Price", sum(table_z."Retail_Chrg") as "Retail_Chrg"
from (
--同一个发药号Grdrug_No中，Min_Unit_Quantity是同一种药的合计发药量，但有可能这种药有几条记录，这几条记录的Min_Unit_Quantity会是相同的总量，然后Retail_Chrg将是每条明细单独的数量*售价单单价
select dsg."Drug_Id" , dsg."Grdrug_No" , dsg."Drug_Code" , "Drug_Name" , dsg."Min_Unit" , dsg."Drug_Strength" , dsg."Min_Unit_Quantity" , dsg."Grdrug_Time" 
, gsd."Recipe_Plcdept" , gsd."Retail_Price" , gsd."Retail_Chrg" , gsd."Storehouse_Unit" 
from "DeptSummaryGrdrug" dsg
join "GrdrugSumDetail" gsd on dsg."Grdrug_Id" = gsd."Grdrug_Id" 
where dsg."Storehouse" = '住院药房'
and dsg."Grdrug_Dispsr" <> '系统管理员'
and dsg."Grdrug_Drugvr" <> '系统管理员'
and dsg."Grdrug_Time" between {:KSSJ} and {:JSSJ}) table_z
group by table_z."Drug_Id", table_z."Grdrug_No", table_z."Drug_Code" , table_z."Drug_Name", table_z."Min_Unit", table_z."Drug_Strength", table_z."Min_Unit_Quantity", table_z."Recipe_Plcdept", table_z."Retail_Price"
)table_zz
group by table_zz."Drug_Id", table_zz."Drug_Code" , table_zz."Drug_Name" , table_zz."Min_Unit" , table_zz."Drug_Strength"
order by table_zz."Drug_Code"
) table_zzz
left join (select rad."Drug_Id" , sum(rad."Min_Unit_Quantity") as "Min_Unit_Quantity" , rad."Min_Unit" , sum(rad."Retail_Chrg") as "Retail_Chrg" 
from "RedrugApply" ra 
join "RedrugApplyDetail" rad on ra."Redrug_Apply_Id" = rad."Redrug_Apply_Id" 
join "RedrugAudit" ra2 on rad."Redrug_Apply_Detail_Id" = ra2."Redrug_Apply_Detail_Id" 
where ra2."Redrug_Time" between {:KSSJ} and {:JSSJ}
group by rad."Drug_Id" , rad."Min_Unit" ) table_RedrugNum on table_zzz."Drug_Id" = table_RedrugNum."Drug_Id"
) table_zzzz
;